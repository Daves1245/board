name: Auto-Implement Feature

on:
  workflow_dispatch:
    inputs:
      feature_id:
        description: Feature ID
        required: true
        type: string
      feature_title:
        description: Feature Title
        required: true
        type: string
      feature_content:
        description: Feature Description
        required: true
        type: string

jobs:
  implement:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Create feature branch
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git checkout -b feature/auto-implement-${{ github.event.inputs.feature_id }}
        echo "Created branch: feature/auto-implement-${{ github.event.inputs.feature_id }}"
    
    - name: Log feature details
      run: |
        echo "=== FEATURE IMPLEMENTATION ==="
        echo "Feature ID: ${{ github.event.inputs.feature_id }}"
        echo "Feature Title: ${{ github.event.inputs.feature_title }}"
        echo "Feature Content: ${{ github.event.inputs.feature_content }}"
        echo "================================"
    
    - name: Install Claude Code CLI
      run: |
        curl -fsSL https://claude.ai/cli/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "Claude CLI installed"
    
    - name: Implement feature with Claude
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "Starting Claude Code implementation..."
        claude-code --prompt "Please implement this feature request for our Next.js feature voting board:

        **Feature Title:** ${{ github.event.inputs.feature_title }}
        **Feature Description:** ${{ github.event.inputs.feature_content }}

        This is a Next.js 14+ app with TypeScript, Tailwind CSS, Prisma ORM, and NextAuth.js authentication. 
        Please analyze the existing codebase structure, implement the requested feature following existing patterns, 
        ensure TypeScript compatibility, maintain existing styling, and commit your changes with a descriptive message.

        Key files to consider:
        - app/page.tsx (main page)
        - app/components/ (React components)  
        - app/api/ (API routes)
        - prisma/schema.prisma (database schema)

        Please implement this feature and integrate it seamlessly with the existing voting board interface."
        echo "Claude Code implementation completed"
    
    - name: Check for changes and push
      run: |
        echo "Checking for changes..."
        git status
        
        if git diff --staged --quiet && git diff --quiet && git ls-files --others --exclude-standard | grep -q .; then
          echo "No changes detected"
        else
          echo "Changes detected, committing..."
          git add .
          git commit -m "feat: auto-implement ${{ github.event.inputs.feature_title }}

          Auto-implemented feature #${{ github.event.inputs.feature_id }}
          ${{ github.event.inputs.feature_content }}

          ðŸ¤– Implemented by Claude Code via GitHub Actions" || echo "Commit failed"
          
          echo "Pushing branch..."
          git push origin feature/auto-implement-${{ github.event.inputs.feature_id }} || echo "Push failed"
        fi
    
    - name: Create Pull Request
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Creating pull request..."
        gh pr create \
          --title "ðŸ¤– Auto-implement: ${{ github.event.inputs.feature_title }}" \
          --body "Auto-implemented feature ID ${{ github.event.inputs.feature_id }}: ${{ github.event.inputs.feature_content }}. Implemented by Claude Code CLI via GitHub Actions." \
          --head feature/auto-implement-${{ github.event.inputs.feature_id }} \
          --base main || echo "PR creation failed"