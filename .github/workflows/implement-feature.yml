name: Auto-Implement Feature

on:
  workflow_dispatch:
    inputs:
      feature_id:
        description: Feature ID
        required: true
        type: string
      feature_title:
        description: Feature Title
        required: true
        type: string
      feature_content:
        description: Feature Description
        required: true
        type: string

jobs:
  implement:
    runs-on: ubuntu-latest
    environment: env
    timeout-minutes: 10
    permissions:
      contents: write
      actions: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Validate GitHub Token
      run: |
        echo "Testing GitHub token validity..."
        
        # Test basic GitHub API access
        response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }})
        
        if echo "$response" | grep -q '"private"'; then
          echo "‚úÖ GitHub token is valid and has repository access"
          echo "Repository: $(echo "$response" | grep '"full_name"' | cut -d'"' -f4)"
        else
          echo "‚ùå GitHub token validation failed"
          echo "Response: $response"
          exit 1
        fi
        
        # Check token permissions
        curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/collaborators/${{ github.actor }}/permission \
          | grep -q '"admin"\|"write"' && echo "‚úÖ Token has write permissions" || echo "‚ö†Ô∏è Limited permissions detected"
    
    - name: Use Claude Code Action
      uses: anthropics/claude-code-action@v1
      timeout-minutes: 5
      continue-on-error: true
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        claude_args: --dangerously-skip-permissions --verbose
        show_full_output: true
        prompt: |
          IMPORTANT: Before implementing this feature, you MUST:
          1. Read CLAUDE.md completely - it contains critical project information
          2. Review the "Project Structure & Key Files" section to understand where to look
          3. Read "Understanding User Intent" to properly analyze this request
          4. Check "Protected Systems" section - NEVER modify the voting mechanism
          5. Read "Verifying Changes" to ensure quality before committing

          Feature Request:
          Title: ${{ github.event.inputs.feature_title }}
          Description: ${{ github.event.inputs.feature_content }}
          Feature ID: ${{ github.event.inputs.feature_id }}

          Implementation Process:
          1. Read CLAUDE.md thoroughly - understand the project architecture and protected systems
          2. Analyze the feature request carefully - understand exactly what is being asked
          3. Review the "Project Structure & Key Files" section to know where each component lives
          4. Explore relevant files in the codebase to understand current implementation patterns
          5. Plan your implementation - identify files to modify and approach to take
          6. CHECK: Does this feature request modify the voting mechanism? If yes, proceed with extreme caution
          7. Implement the feature following existing code patterns and standards
          8. If the feature requests documentation updates, follow the "Documentation Updates" guidelines
          9. Run `npm run build` to verify no errors
          10. Verify the implementation matches the feature request exactly
          11. Commit your changes with a clear message referencing feature ID ${{ github.event.inputs.feature_id }}

          CRITICAL REMINDERS:
          - The voting and auto-implementation system is the core of The Board
          - NEVER modify voting logic unless the feature explicitly requests it
          - Follow the exact patterns in CLAUDE.md
          - Implement ONLY what is requested, nothing more
          - Verify your work matches the request before committing
          - Ensure the build succeeds before committing

    - name: Check Claude Code results and commit
      if: always()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Checking Claude Code Action results..."
        
        echo "Current git status:"
        git status
        
        echo "Configuring git user..."
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"
        
        echo "Setting up authentication..."
        git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "‚ö†Ô∏è No changes detected from Claude Code"
          echo "Creating placeholder commit to indicate attempt..."
          echo "Claude Code attempted to implement: ${{ github.event.inputs.feature_title }}" > claude-attempt.log
          echo "Feature Description: ${{ github.event.inputs.feature_content }}" >> claude-attempt.log
          echo "Timestamp: $(date)" >> claude-attempt.log
          git add claude-attempt.log
          git commit -m "docs: Claude Code implementation attempt for ${{ github.event.inputs.feature_title }}

          Claude Code was triggered but may have timed out or failed to make changes.
          Feature ID: ${{ github.event.inputs.feature_id }}
          
          ü§ñ Attempted via GitHub Actions"
        else
          echo "‚úÖ Changes detected, committing implementation..."
          git add .
          git commit -m "feat: auto-implement ${{ github.event.inputs.feature_title }}

          Auto-implemented feature #${{ github.event.inputs.feature_id }}
          ${{ github.event.inputs.feature_content }}

          ü§ñ Implemented by Claude Code via GitHub Actions"
        fi
        
        echo "About to push to: $(git remote get-url origin)"
        echo "Current branch: $(git branch --show-current)"
        
        echo "Pushing changes..."
        git push origin HEAD:main || {
          echo "‚ùå Push failed with exit code $?"
          echo "Git status:"
          git status
          echo "Remote URL:"
          git remote get-url origin
          echo "Git log:"
          git log -1 --oneline
          exit 1
        }
        
        echo "‚úÖ Successfully pushed changes!"
        
    - name: Trigger deployment
      if: success()
      run: |
        echo "üöÄ Changes pushed to main - Vercel will auto-deploy"
        echo "The Board will be updated with new feature in 1-2 minutes"
        echo "Feature: ${{ github.event.inputs.feature_title }}"
        
        # Optional: Trigger deployment workflow explicitly  
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/dispatches \
          -d '{"ref":"main"}' || echo "Manual trigger failed, but auto-deploy will still work"