name: Auto-Implement Feature

on:
  workflow_dispatch:
    inputs:
      feature_id:
        description: Feature ID
        required: true
        type: string
      feature_title:
        description: Feature Title
        required: true
        type: string
      feature_content:
        description: Feature Description
        required: true
        type: string

jobs:
  implement:
    runs-on: ubuntu-latest
    environment: env
    timeout-minutes: 10
    permissions:
      contents: write
      actions: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Validate GitHub Token
      run: |
        echo "Testing GitHub token validity..."
        
        # Test basic GitHub API access
        response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }})
        
        if echo "$response" | grep -q '"private"'; then
          echo "‚úÖ GitHub token is valid and has repository access"
          echo "Repository: $(echo "$response" | grep '"full_name"' | cut -d'"' -f4)"
        else
          echo "‚ùå GitHub token validation failed"
          echo "Response: $response"
          exit 1
        fi
        
        # Check token permissions
        curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/collaborators/${{ github.actor }}/permission \
          | grep -q '"admin"\|"write"' && echo "‚úÖ Token has write permissions" || echo "‚ö†Ô∏è Limited permissions detected"
    
    - name: Use Claude Code Action
      uses: anthropics/claude-code-action@v1
      timeout-minutes: 5
      continue-on-error: true
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        claude_args: --dangerously-skip-permissions --verbose
        show_full_output: true
        prompt: |
          Please implement this feature request for our Next.js feature voting board:
          
          Feature Title: ${{ github.event.inputs.feature_title }}
          Feature Description: ${{ github.event.inputs.feature_content }}
          
          This is a Next.js 14+ app with TypeScript, Tailwind CSS, Prisma ORM, and NextAuth.js authentication.
          Please analyze the existing codebase structure, implement the requested feature following existing patterns,
          ensure TypeScript compatibility, maintain existing styling, and commit your changes.
          
          Key files: app/page.tsx, app/components/, app/api/, prisma/schema.prisma
          
          Please implement this feature and integrate it seamlessly with the existing voting board interface.

    - name: Check Claude Code results and commit
      if: always()
      run: |
        echo "Checking Claude Code Action results..."
        
        echo "Current git status:"
        git status
        
        echo "Configuring git..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        echo "Setting up git authentication..."
        git remote -v
        echo "Current remote URL: $(git remote get-url origin)"
        
        # Set up authentication using token
        git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
        echo "Updated remote URL: $(git remote get-url origin)"
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "‚ö†Ô∏è No changes detected from Claude Code"
          echo "Creating placeholder commit to indicate attempt..."
          echo "Claude Code attempted to implement: ${{ github.event.inputs.feature_title }}" > claude-attempt.log
          echo "Feature Description: ${{ github.event.inputs.feature_content }}" >> claude-attempt.log
          echo "Timestamp: $(date)" >> claude-attempt.log
          git add claude-attempt.log
          git commit -m "docs: Claude Code implementation attempt for ${{ github.event.inputs.feature_title }}

          Claude Code was triggered but may have timed out or failed to make changes.
          Feature ID: ${{ github.event.inputs.feature_id }}
          
          ü§ñ Attempted via GitHub Actions"
        else
          echo "‚úÖ Changes detected, committing implementation..."
          git add .
          git commit -m "feat: auto-implement ${{ github.event.inputs.feature_title }}

          Auto-implemented feature #${{ github.event.inputs.feature_id }}
          ${{ github.event.inputs.feature_content }}

          ü§ñ Implemented by Claude Code via GitHub Actions"
        fi
        
        echo "Pushing to main..."
        echo "About to push with remote: $(git remote get-url origin)"
        
        if git push origin main; then
          echo "‚úÖ Successfully pushed to main!"
        else
          echo "‚ùå Push failed. Attempting troubleshooting..."
          echo "Git status after failed push:"
          git status
          echo "Remote info:"
          git remote -v
          echo "Current branch:"
          git branch
          echo "Last commit:"
          git log -1 --oneline
          
          # Try alternative push method
          echo "Trying alternative push method..."
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:main || {
            echo "‚ùå Alternative push also failed"
            exit 1
          }
        fi
        
        echo "‚úÖ Workflow complete!"