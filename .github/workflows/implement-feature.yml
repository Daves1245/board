name: Auto-Implement Feature

on:
  workflow_dispatch:
    inputs:
      feature_id:
        description: Feature ID
        required: true
        type: string
      feature_title:
        description: Feature Title
        required: true
        type: string
      feature_content:
        description: Feature Description
        required: true
        type: string

jobs:
  implement:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Verify API Key
      run: |
        if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
          echo "‚ùå ANTHROPIC_API_KEY secret is not set or empty"
          echo "Please add your Anthropic API key as ANTHROPIC_API_KEY in repository secrets"
          echo "Go to: Repository Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
          exit 1
        else
          echo "‚úÖ ANTHROPIC_API_KEY secret is available"
        fi
    
    - name: Use Claude Code Action
      uses: anthropics/claude-code-action@v1
      timeout-minutes: 8
      continue-on-error: false
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        claude_args: --dangerously-skip-permissions --timeout 300
        prompt: |
          Please implement this feature request for our Next.js feature voting board:
          
          Feature Title: ${{ github.event.inputs.feature_title }}
          Feature Description: ${{ github.event.inputs.feature_content }}
          
          This is a Next.js 14+ app with TypeScript, Tailwind CSS, Prisma ORM, and NextAuth.js authentication.
          Please analyze the existing codebase structure, implement the requested feature following existing patterns,
          ensure TypeScript compatibility, maintain existing styling, and commit your changes.
          
          Key files: app/page.tsx, app/components/, app/api/, prisma/schema.prisma
          
          Please implement this feature and integrate it seamlessly with the existing voting board interface.

    - name: Check for changes and commit
      run: |
        echo "Checking for file changes..."
        git status
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "‚ùå No changes detected - Claude Code may have failed"
          exit 1
        else
          echo "‚úÖ Changes detected, proceeding with commit..."
        fi
        
        echo "Configuring git..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        echo "Adding and committing changes..."
        git add .
        git commit -m "feat: auto-implement ${{ github.event.inputs.feature_title }}

        Auto-implemented feature #${{ github.event.inputs.feature_id }}
        ${{ github.event.inputs.feature_content }}

        ü§ñ Implemented by Claude Code via GitHub Actions"
        
        echo "Pushing to main..."
        git push origin main
        
        echo "‚úÖ Feature implementation complete!"